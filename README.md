# FFmpeg Mac æ„å»ºå·¥å…· v2.0

è¿™æ˜¯ä¸€ä¸ªç”¨äºåœ¨ macOS ä¸Šæ„å»º FFmpeg å¼€å‘ç¯å¢ƒçš„è‡ªåŠ¨åŒ–è„šæœ¬å·¥å…·é›†ã€‚

## ğŸ†• v2.0 æ–°ç‰¹æ€§

- âœ… **å¢é‡æ„å»º** - æ™ºèƒ½æ£€æµ‹å˜æ›´ï¼Œåªé‡æ–°ç¼–è¯‘ä¿®æ”¹è¿‡çš„åº“
- âœ… **ç‰ˆæœ¬ç®¡ç†** - æ”¯æŒç¨³å®šç‰ˆå’Œå¼€å‘ç‰ˆåˆ‡æ¢
- âœ… **æ¨¡å—åŒ–æ¶æ„** - æ¯ä¸ªåº“ç‹¬ç«‹æ„å»ºè„šæœ¬ï¼Œæ˜“äºç»´æŠ¤
- âœ… **å¹¶è¡Œæ„å»º** - å¤šæ ¸å¹¶è¡Œç¼–è¯‘ï¼Œå¤§å¹…æå‡æ„å»ºé€Ÿåº¦
- âœ… **çµæ´»é…ç½®** - ä¸°å¯Œçš„å‘½ä»¤è¡Œé€‰é¡¹å’Œé…ç½®æ–‡ä»¶
- âœ… **ç¯å¢ƒç®¡ç†** - ä¸€é”®è®¾ç½®ç¯å¢ƒå˜é‡
- âœ… **æ¸…ç†åŠŸèƒ½** - æ”¯æŒå¤šç§æ¸…ç†æ¨¡å¼

## å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

1. **macOS** (æ¨è macOS 10.15 æˆ–æ›´é«˜ç‰ˆæœ¬)
2. **Homebrew** - macOS åŒ…ç®¡ç†å™¨
   ```bash
   /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
   ```
3. **Xcode Command Line Tools**
   ```bash
   xcode-select --install
   ```

### åŸºæœ¬ç”¨æ³•

1. **å…‹éš†é¡¹ç›®**
   ```bash
   git clone <repository-url>
   cd ffmpeg-build-mac
   ```

2. **è¿è¡Œæ„å»º**
   ```bash
   ./build_mac.sh
   ```

3. **è®¾ç½®ç¯å¢ƒå˜é‡**
   ```bash
   source ./env_setup.sh -t    # ä¸´æ—¶è®¾ç½®
   # æˆ–
   source ./env_setup.sh -p    # æ°¸ä¹…è®¾ç½®
   ```

4. **éªŒè¯å®‰è£…**
   ```bash
   ffmpeg -version
   ```

## é¡¹ç›®ç»“æ„

```
ffmpeg-build-mac/
â”œâ”€â”€ build_mac.sh          # æ–°ç‰ˆä¸»æ„å»ºè„šæœ¬
â”œâ”€â”€ build_mac.sh             # æ—§ç‰ˆæ„å»ºè„šæœ¬ï¼ˆä¿ç•™ï¼‰
â”œâ”€â”€ env_setup.sh             # ç¯å¢ƒå˜é‡è®¾ç½®è„šæœ¬
â”œâ”€â”€ validate.sh              # éªŒè¯è„šæœ¬
â”œâ”€â”€ config/                  # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ versions.conf        # ç‰ˆæœ¬ç®¡ç†é…ç½®
â”œâ”€â”€ scripts/                 # æ„å»ºè„šæœ¬ç›®å½•
â”‚   â”œâ”€â”€ common.sh            # é€šç”¨å‡½æ•°åº“
â”‚   â”œâ”€â”€ parallel_builder.sh  # å¹¶è¡Œæ„å»ºè°ƒåº¦å™¨
â”‚   â””â”€â”€ libs/                # å„åº“çš„æ„å»ºè„šæœ¬
â”‚       â”œâ”€â”€ build_x264.sh
â”‚       â”œâ”€â”€ build_x265.sh
â”‚       â”œâ”€â”€ build_fdk_aac.sh
â”‚       â”œâ”€â”€ build_lame.sh
â”‚       â”œâ”€â”€ build_opus.sh
â”‚       â”œâ”€â”€ build_libvpx.sh
â”‚       â”œâ”€â”€ build_libaom.sh
â”‚       â”œâ”€â”€ build_openh264.sh
â”‚       â”œâ”€â”€ build_kvazaar.sh
â”‚       â”œâ”€â”€ build_svtav1.sh
â”‚       â”œâ”€â”€ build_dav1d.sh
â”‚       â””â”€â”€ build_ffmpeg.sh
â”œâ”€â”€ ffmpeg_sources/          # å¤–éƒ¨åº“æºä»£ç ï¼ˆæ„å»ºæ—¶åˆ›å»ºï¼‰
â””â”€â”€ ffmpeg_build/            # ç¼–è¯‘äº§ç‰©ï¼ˆæ„å»ºæ—¶åˆ›å»ºï¼‰
    â”œâ”€â”€ .build_markers/      # æ„å»ºçŠ¶æ€æ ‡è®°ï¼ˆå¢é‡æ„å»ºï¼‰
    â”œâ”€â”€ bin/                 # å¯æ‰§è¡Œæ–‡ä»¶
    â”œâ”€â”€ lib/                 # åŠ¨æ€åº“
    â”œâ”€â”€ include/             # å¤´æ–‡ä»¶
    â””â”€â”€ share/               # å…¶ä»–æ–‡ä»¶
```

## ä½¿ç”¨æŒ‡å—

### æ„å»ºé€‰é¡¹

```bash
# æ˜¾ç¤ºå¸®åŠ©
./build_mac.sh --help

# å¹¶è¡Œæ„å»ºï¼ˆé»˜è®¤4ä¸ªä»»åŠ¡ï¼‰
./build_mac.sh

# è‡ªå®šä¹‰å¹¶è¡Œä»»åŠ¡æ•°
./build_mac.sh -j 8

# é¡ºåºæ„å»º
./build_mac.sh --sequential

# å¼ºåˆ¶é‡æ–°ç¼–è¯‘æ‰€æœ‰åº“
./build_mac.sh --force

# åªæ„å»ºç‰¹å®šçš„åº“
./build_mac.sh --lib x264 --lib x265

# æ¸…ç†æ„å»ºäº§ç‰©
./build_mac.sh --clean build

# æ¸…ç†æ‰€æœ‰ï¼ˆåŒ…æ‹¬æºç ï¼‰
./build_mac.sh --clean all

# ä¿å­˜æ„å»ºæ—¥å¿—åˆ°æ–‡ä»¶
./build_mac.sh --log-file build.log

# è¯¦ç»†è¾“å‡ºæ¨¡å¼
./build_mac.sh -v

# å®‰é™æ¨¡å¼ï¼ˆåªæ˜¾ç¤ºé”™è¯¯å’Œè­¦å‘Šï¼‰
./build_mac.sh -q
```

### ç‰ˆæœ¬ç®¡ç†

ç¼–è¾‘ `config/versions.conf` æ–‡ä»¶æ¥æ§åˆ¶å„åº“çš„ç‰ˆæœ¬ï¼š

```bash
# ä½¿ç”¨æœ€æ–°å¼€å‘ç‰ˆï¼ˆé»˜è®¤ï¼‰
BUILD_MODE="latest"

# åˆ‡æ¢åˆ°ç¨³å®šç‰ˆ
BUILD_MODE="stable"
X264_VERSION="stable"
X265_VERSION="3.5"
# ... å…¶ä»–åº“çš„ç‰ˆæœ¬
```

æˆ–è€…é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šï¼š

```bash
./build_mac.sh --version stable
```

### å¢é‡æ„å»º

v2.0 ç‰ˆæœ¬æ”¯æŒæ™ºèƒ½å¢é‡æ„å»ºï¼š

- é¦–æ¬¡è¿è¡Œä¼šç¼–è¯‘æ‰€æœ‰åº“
- åç»­è¿è¡Œåªä¼šé‡æ–°ç¼–è¯‘ï¼š
  - æºä»£ç æœ‰å˜æ›´çš„åº“
  - ä¾èµ–é¡¹è¢«é‡æ–°ç¼–è¯‘çš„åº“
- ä½¿ç”¨ `--force` å¼ºåˆ¶é‡æ–°ç¼–è¯‘æ‰€æœ‰åº“

### ç¯å¢ƒè®¾ç½®

ä½¿ç”¨ `env_setup.sh` è„šæœ¬ç®¡ç†ç¯å¢ƒå˜é‡ï¼š

```bash
# æŸ¥çœ‹å½“å‰ç¯å¢ƒ
./env_setup.sh --show

# ä¸´æ—¶è®¾ç½®ï¼ˆå½“å‰ç»ˆç«¯ä¼šè¯ï¼‰
source ./env_setup.sh --temporary

# æ°¸ä¹…è®¾ç½®ï¼ˆæ·»åŠ åˆ° shell é…ç½®æ–‡ä»¶ï¼‰
source ./env_setup.sh --permanent

# ç§»é™¤æ°¸ä¹…è®¾ç½®
./env_setup.sh --uninstall
```

### å•ç‹¬æ„å»ºæŸä¸ªåº“

æ¯ä¸ªåº“éƒ½æœ‰ç‹¬ç«‹çš„æ„å»ºè„šæœ¬ï¼Œå¯ä»¥å•ç‹¬è¿è¡Œï¼š

```bash
# å•ç‹¬æ„å»º x264
./scripts/libs/build_x264.sh ./ffmpeg_sources ./ffmpeg_build

# æˆ–ä½¿ç”¨ä¸»è„šæœ¬
./build_mac.sh --lib x264
```

## åŒ…å«çš„ç¼–ç å™¨å’Œåº“

- **è§†é¢‘ç¼–ç å™¨:**
  - H.264 (libx264, openh264)
  - H.265/HEVC (libx265, Kvazaar)
  - VP8/VP9 (libvpx)
  - AV1 (libaom, SVT-AV1, dav1d)

- **éŸ³é¢‘ç¼–ç å™¨:**
  - AAC (libfdk_aac)
  - MP3 (libmp3lame)
  - Opus (libopus)

- **è§†é¢‘å¤„ç†:**
  - libplacebo (GPU åŠ é€Ÿè§†é¢‘å¤„ç†)

## ğŸ”§ Debugç¼–è¯‘æ”¯æŒ

v2.0ç‰ˆæœ¬æ–°å¢äº†debugç¼–è¯‘æ”¯æŒï¼Œå¯ä»¥æ„å»ºåŒ…å«è°ƒè¯•ç¬¦å·çš„ç‰ˆæœ¬ï¼Œä¾¿äºè°ƒè¯•å’Œé—®é¢˜æ’æŸ¥ã€‚

### âœ… æ”¯æŒçš„åº“

**æ‰€æœ‰13ä¸ªåº“éƒ½æ”¯æŒdebugç¼–è¯‘ï¼š**
- âœ… FFmpeg
- âœ… x264 (H.264ç¼–ç å™¨)
- âœ… x265 (H.265/HEVCç¼–ç å™¨)
- âœ… fdk-aac (AACéŸ³é¢‘ç¼–ç å™¨)
- âœ… lame (MP3éŸ³é¢‘ç¼–ç å™¨)
- âœ… opus (OpuséŸ³é¢‘ç¼–ç å™¨)
- âœ… libvpx (VP8/VP9è§†é¢‘ç¼–ç å™¨)
- âœ… libaom (AV1è§†é¢‘ç¼–ç å™¨)
- âœ… openh264 (H.264ç¼–ç å™¨)
- âœ… kvazaar (H.265/HEVCç¼–ç å™¨)
- âœ… svtav1 (AV1è§†é¢‘ç¼–ç å™¨)
- âœ… dav1d (AV1è§†é¢‘è§£ç å™¨)
- âœ… libplacebo (GPUåŠ é€Ÿè§†é¢‘å¤„ç†)

### Debugæ¨¡å¼æ„å»º

```bash
# æ„å»ºæ‰€æœ‰åº“çš„debugç‰ˆæœ¬
./build_mac.sh --debug

# åªæ„å»ºFFmpegçš„debugç‰ˆæœ¬
./build_mac.sh --debug --lib ffmpeg

# è‡ªå®šä¹‰debugç¼–è¯‘æ ‡å¿—
./build_mac.sh --debug --debug-flags="-g -O1 -fno-omit-frame-pointer"

# å¹¶è¡Œdebugæ„å»ºï¼ˆ8ä¸ªä»»åŠ¡ï¼‰
./build_mac.sh --debug -j 8
```

### Debugæ¨¡å¼ç‰¹æ€§

- **è°ƒè¯•ç¬¦å·**: åŒ…å«å®Œæ•´çš„è°ƒè¯•ä¿¡æ¯ï¼Œæ”¯æŒgdbã€lldbç­‰è°ƒè¯•å™¨
- **ä¼˜åŒ–çº§åˆ«**: é»˜è®¤ä½¿ç”¨-O0ï¼ˆæ— ä¼˜åŒ–ï¼‰ï¼Œä¾¿äºè°ƒè¯•
- **å¢é‡æ„å»º**: debugæ¨¡å¼å˜æ›´ä¼šè‡ªåŠ¨è§¦å‘é‡æ–°ç¼–è¯‘
- **æ„å»ºæ ‡è®°**: è®°å½•debugçŠ¶æ€ï¼Œä¾¿äºè¿½è¸ª

### éªŒè¯Debugæ„å»º

ä½¿ç”¨ä¸“é—¨çš„éªŒè¯è„šæœ¬æ£€æŸ¥debugæ„å»ºæ˜¯å¦æˆåŠŸï¼š

```bash
# éªŒè¯debugæ„å»º
./validate_debug.sh

# æ£€æŸ¥ç‰¹å®šæ–‡ä»¶
file ./ffmpeg_build/bin/ffmpeg
nm -g ./ffmpeg_build/bin/ffmpeg | grep -i debug

# ä½¿ç”¨lldbè°ƒè¯•
lldb ./ffmpeg_build/bin/ffmpeg
```

### Debugæ¨¡å¼åˆ‡æ¢

```bash
# ä»releaseåˆ‡æ¢åˆ°debugï¼ˆéœ€è¦é‡æ–°ç¼–è¯‘ï¼‰
./build_mac.sh --debug --force

# ä»debugåˆ‡æ¢å›release
./build_mac.sh --force
```

### è°ƒè¯•ç¤ºä¾‹

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
source ./env_setup.sh -t

# ä½¿ç”¨lldbè°ƒè¯•FFmpeg
lldb ./ffmpeg_build/bin/ffmpeg
(lldb) run -version
(lldb) breakpoint set --name main
(lldb) continue

# ä½¿ç”¨gdbè°ƒè¯•
DYLD_LIBRARY_PATH=./ffmpeg_build/lib gdb ./ffmpeg_build/bin/ffmpeg
(gdb) break main
(gdb) run
```

## é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰é…ç½®

ç¼–è¾‘å„åº“çš„æ„å»ºè„šæœ¬æ¥è‡ªå®šä¹‰ç¼–è¯‘é€‰é¡¹ï¼š

```bash
# ä¿®æ”¹ x264 çš„é…ç½®é€‰é¡¹
vim scripts/libs/build_x264.sh
```

### æ·»åŠ æ–°çš„ç¼–ç å™¨

1. åœ¨ `scripts/libs/` ä¸­åˆ›å»ºæ–°çš„æ„å»ºè„šæœ¬
2. åœ¨ `scripts/parallel_builder.sh` ä¸­æ·»åŠ åˆ°æ„å»ºç»„
3. åœ¨ `config/versions.conf` ä¸­æ·»åŠ ç‰ˆæœ¬é…ç½®

### è°ƒè¯•æ„å»ºé—®é¢˜

```bash
# å¯ç”¨è¯¦ç»†è¾“å‡º
set -x
./build_mac.sh

# æŸ¥çœ‹æ„å»ºçŠ¶æ€
ls -la ffmpeg_build/.build_markers/

# æ¸…ç†å¹¶é‡è¯•
./build_mac.sh --clean build --force
```

## æ€§èƒ½å¯¹æ¯”

| æ„å»ºæ¨¡å¼ | é¦–æ¬¡æ„å»º | å¢é‡æ„å»º | æ— å˜æ›´ |
|---------|---------|---------|--------|
| v1.0 é¡ºåº | ~60åˆ†é’Ÿ | ~60åˆ†é’Ÿ | ~60åˆ†é’Ÿ |
| v2.0 é¡ºåº | ~60åˆ†é’Ÿ | ~5-15åˆ†é’Ÿ | ~10ç§’ |
| v2.0 å¹¶è¡Œ(j4) | ~25åˆ†é’Ÿ | ~5-10åˆ†é’Ÿ | ~10ç§’ |
| v2.0 å¹¶è¡Œ(j8) | ~15åˆ†é’Ÿ | ~3-8åˆ†é’Ÿ | ~10ç§’ |

*æ€§èƒ½æ•°æ®å› ç¡¬ä»¶é…ç½®å’Œç½‘ç»œé€Ÿåº¦è€Œå¼‚*

## ä» v1.0 è¿ç§»

å¦‚æœä½ å·²ç»ä½¿ç”¨æ—§ç‰ˆ `build_mac.sh`ï¼š

1. ä¿ç•™ç°æœ‰çš„æ„å»ºç›®å½•
2. ç›´æ¥ä½¿ç”¨æ–°ç‰ˆè„šæœ¬ï¼š
   ```bash
   ./build_mac.sh
   ```
3. v2.0 ä¼šæ£€æµ‹å·²æ„å»ºçš„åº“ï¼Œè·³è¿‡ä¸å¿…è¦çš„é‡æ–°ç¼–è¯‘

## æ•…éšœæ’é™¤

### é—®é¢˜ï¼šæ„å»ºå¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
./build_mac.sh -j 1  # å•çº¿ç¨‹æ›´å®¹æ˜“çœ‹åˆ°é”™è¯¯

# æ¸…ç†å¹¶é‡è¯•
./build_mac.sh --clean build --force
```

### é—®é¢˜ï¼šå¢é‡æ„å»ºæœªç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥æ„å»ºæ ‡è®°
ls -la ffmpeg_build/.build_markers/

# å¼ºåˆ¶é‡æ–°æ„å»º
./build_mac.sh --force
```

### é—®é¢˜ï¼šç¯å¢ƒå˜é‡æœªç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥å½“å‰ç¯å¢ƒ
./env_setup.sh --show

# é‡æ–°è®¾ç½®
source ./env_setup.sh -t
```

### é—®é¢˜ï¼šè¿è¡Œæ—¶æ‰¾ä¸åˆ°åŠ¨æ€åº“

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# è®¾ç½®åŠ¨æ€åº“è·¯å¾„
export DYLD_LIBRARY_PATH="$(pwd)/ffmpeg_build/lib:$DYLD_LIBRARY_PATH"

# æˆ–ä½¿ç”¨ç¯å¢ƒè®¾ç½®è„šæœ¬
source ./env_setup.sh -t
```

## å¸¸è§é—®é¢˜

**Q: v2.0 å’Œ v1.0 æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

A: v2.0 ä¸»è¦æ”¹è¿›ï¼š
- å¢é‡æ„å»ºï¼ˆèŠ‚çœå¤§é‡æ—¶é—´ï¼‰
- å¹¶è¡Œç¼–è¯‘ï¼ˆæ›´å¿«ï¼‰
- ç‰ˆæœ¬ç®¡ç†ï¼ˆå¯æ§çš„ç‰ˆæœ¬ï¼‰
- æ¨¡å—åŒ–æ¶æ„ï¼ˆæ˜“ç»´æŠ¤ï¼‰
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

**Q: å¯ä»¥åŒæ—¶ä½¿ç”¨ v1.0 å’Œ v2.0 å—ï¼Ÿ**

A: å¯ä»¥ï¼Œå®ƒä»¬å…±äº«ç›¸åŒçš„æ„å»ºç›®å½•ç»“æ„ï¼Œäº’ç›¸å…¼å®¹ã€‚

**Q: å¦‚ä½•å›åˆ°ç‰¹å®šç‰ˆæœ¬çš„åº“ï¼Ÿ**

A: ç¼–è¾‘ `config/versions.conf`ï¼ŒæŒ‡å®šå…·ä½“çš„ç‰ˆæœ¬å·æˆ– commit hashã€‚

**Q: å¹¶è¡Œæ„å»ºå®‰å…¨å—ï¼Ÿ**

A: æ˜¯çš„ã€‚æˆ‘ä»¬ä»”ç»†ç®¡ç†äº†ä¾èµ–å…³ç³»ï¼Œç¡®ä¿æœ‰ä¾èµ–çš„åº“æŒ‰æ­£ç¡®é¡ºåºæ„å»ºã€‚

**Q: å¢é‡æ„å»ºå¦‚ä½•åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°ç¼–è¯‘ï¼Ÿ**

A: é€šè¿‡æ¯”è¾ƒæºæ–‡ä»¶ä¿®æ”¹æ—¶é—´å’Œæ„å»ºæ ‡è®°æ—¶é—´ã€‚å¦‚æœæœ‰ç–‘é—®ï¼Œä½¿ç”¨ `--force` å¼ºåˆ¶é‡æ–°ç¼–è¯‘ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## è®¸å¯è¯

æœ¬å·¥å…·è„šæœ¬éµå¾ªä¸åŸ FFmpeg é¡¹ç›®ç›¸åŒçš„è®¸å¯è¯ã€‚å„ç¬¬ä¸‰æ–¹åº“çš„è®¸å¯è¯ï¼š

- FFmpeg: LGPL/GPL
- libx264, libx265: GPL
- libfdk_aac: Fraunhofer FDK AAC License (éè‡ªç”±è½¯ä»¶)
- libmp3lame: LGPL
- libopus, libvpx, libaom: BSD

ä½¿ç”¨ `--enable-nonfree` å’Œ `--enable-gpl` é€‰é¡¹æ„å‘³ç€ä½ æ¥å—ç›¸åº”çš„è®¸å¯è¯æ¡æ¬¾ã€‚

## å‚è€ƒ

- [FFmpeg å®˜æ–¹ç¼–è¯‘æŒ‡å—](https://trac.ffmpeg.org/wiki/CompilationGuide)
- [FFmpeg å®˜æ–¹æ–‡æ¡£](https://ffmpeg.org/documentation.html)
- [åŸç‰ˆ README](README.md)
- [è¯¦ç»†æ„å»ºè¯´æ˜](BUILD_MAC.md)
